<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<link rel="stylesheet" type="text/css" href="css/style.css"></link>
  <script src="https://d3js.org/d3.v3.min.js"></script>
	<script src="https://d3js.org/queue.v1.min.js"></script>
	<script src="https://d3js.org/topojson.v1.min.js"></script>
	<script src="https://d3js.org/colorbrewer.v1.min.js"></script>
	<style>

		.counties {
		  fill: none;
		}

		.states {
		  fill: none;
		  stroke: #fff;
		  stroke-linejoin: round;
		}

	</style>
</head>
<body>
  <div id="tooltip" class="hidden"> 
    <p id="taxa"> </p>
  </div> 
  <h1>Taxa de desemprego nos EUA em 2008</h1>
<script>

var width = 960,
    height = 600;

var rateById = d3.map();

var nameById = d3.map();

var quantize = d3.scale.quantize()
    .domain([0, .15])
    .range(colorbrewer.Blues[9]);

var projection = d3.geo.albersUsa()
    .scale(1280)
    .translate([width / 2, height / 2]);

var path = d3.geo.path()
    .projection(projection);

var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);

queue()
    .defer(d3.json, "us.json")
    .defer(d3.tsv, "unemployment.tsv", function(d) { rateById.set(d.id, +d.rate); })
    .defer(d3.csv, "county_names.csv", function(d) { nameById.set(d.id, d.name); })
    .await(ready);

function showTooltip(county_id, x, y){
  d3.select("#tooltip")
    .style("left", x + "px")
    .style("top", y + "px")
    .select("#taxa")
    .html( nameById.get(county_id)+ "</br>" + "Taxa de desemprego: " + rateById.get(county_id) );
    
  d3.select("#tooltip")
    .classed("hidden", false);

}

function hideTooltip(){
  d3.select("#tooltip")
  .classed("hidden", true);
}


function ready(error, us) {
  if (error) throw error;

  svg.append("g")
      .attr("class", "counties")
    .selectAll("path")
      .data(topojson.feature(us, us.objects.counties).features)
    .enter().append("path")
      .attr("fill", function(d) { return quantize(rateById.get(d.id)); })
      .attr("d", path);

  svg.append("path")
      .datum(topojson.mesh(us, us.objects.states, function(a, b) { return a !== b; }))
      .attr("class", "states")
      .attr("d", path);

  svg.append("g")
      .attr("class", "counties")
      .selectAll("path")
      .data(topojson.feature(us, us.objects.counties).features)
      .enter().append("path")
        .attr("fill", function(d) { return quantize(rateById.get(d.id)); })
        .attr("d", path)
        .on("mouseover", function(d){
			d3.select(this) // seleciona o elemento atual
				.style("cursor", "pointer") //muda o mouse para mãozinha
				.attr("stroke-width", 3)
				.attr("stroke","#fff");

	      	var coordinates = [0, 0];
			coordinates = d3.mouse(this); // obtém a posição do mouse relativa a this
			var x = coordinates[0] + 10;
			var y = coordinates[1] + 20; //descontando a posição do svg
			
			showTooltip(d.id, x, y);
		})
        .on("mouseout", function(d){
			d3.select(this)
				.style("cursor", "default")
				.attr("stroke-width", 0)
				.attr("stroke","none"); //volta ao valor padrão

			hideTooltip();
        })
        .append("title")
          .text(function(d) {
          return nameById.get(d.id) + "\nTaxa de desemprego: "+rateById.get(d.id);
        });
}

d3.select(self.frameElement).style("height", height + "px");

</script>
</body>
</html>